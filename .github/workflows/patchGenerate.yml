name: Patch Generate

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'patch version'
        required: true

jobs:
  PatchGenerate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        framework: [preact]
    steps:
      - name: Checkout snapfu-patches repositiory
        uses: actions/checkout@v3
        with:
          repository: "searchspring/snapfu-patches"
          path: "snapfu-patches"
          ref: "main"

      - name: Set Github credentials
        run: |
          git config user.name searchspring-machine
          git config user.email machine@searchspring.com
      
      - name: Setup Node
        uses: actions/setup-node@v2
        with:
          node-version: 16
          registry-url: 'https://registry.npmjs.org'

      - name: Generate ${{ matrix.framework }} patch file
        run: |
          node scripts/generatePatchFile.js --version ${{ inputs.version }} --framework ${{ matrix.framework }}
          cp patch.${{ matrix.framework }}.${{ inputs.version }}.yml snapfu-patches/${{ matrix.framework }}/${{ inputs.version }}/patch.${{ matrix.framework }}.${{ inputs.version }}.yml

      - name: Commit patch files
        working-directory: snapfu-patches
        run: |
          git checkout -b patch-generate-${{ inputs.version }}
          git add patch.*.yml
          git commit -m "auto generated patch files from Snap action workflow_dispatch"
          git push -u origin patch-generate-${{ inputs.version }}

      - name: Create PR
        run: |
          gh pr create --title "Patch file ${{ matrix.framework }}/${{ inputs.version }}" --body "" --repo "https://github.com/searchspring/snapfu-patches" --base "main" --head "patch-generate-${{ inputs.version }}" --reviewer "searchspring/snap-team" --project "Snap Beta"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
